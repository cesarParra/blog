---
import Header from "../components/Header.astro";
import BaseHead from "../components/BaseHead.astro";
import { Footer } from "../components/Footer.tsx";
import { Container } from "../components/Container.tsx";

const { title, description, isHomePage = false } = Astro.props;
---
<!doctype html>
<html class="h-full antialiased" lang="en">
<head>
  <BaseHead title={ title } description={ description }/>

  <style is:global>
      .closeButton {
          display: none;
      }
  </style>

  <style>
      .closeButton {
          display: none;
      }
  </style>
</head>

<body class="flex min-h-full bg-slate-50 dark:bg-black">
<main class="flex w-full">
  <div class="fixed inset-0 flex justify-center sm:px-8">
    <div class="flex w-full max-w-7xl lg:px-8">
      <div class="w-full bg-white ring-1 ring-slate-100 dark:bg-slate-900 dark:ring-slate-300/20"/>
    </div>
  </div>
  <div class="relative flex w-full flex-col">
    <Header isHomePage={ isHomePage }/>
    <main class="flex-auto">
      <slot/>
    </main>
    <Container>
      <Footer/>
    </Container>
  </div>
</main>
</body>
<script type='text/javascript'>
  function initEmbeddedMessaging() {
    try {
      embeddedservice_bootstrap.settings.language = 'en_US'; // For example, enter 'en' or 'en-US'

      embeddedservice_bootstrap.init(
        '00DWC000002CRRV',
        'Messaging_For_In_App_Rad_1',
        'https://wheretherebedragons--testville.sandbox.my.site.com/ESWMessagingForInAppR1759343674368',
        {
          scrt2URL: 'https://wheretherebedragons--testville.sandbox.my.salesforce-scrt.com'
        }
      );
    } catch (err) {
      console.error('Error loading Embedded Messaging: ', err);
    }
  }

  initEmbeddedMessaging();
</script>
<script type='text/javascript' src='https://wheretherebedragons--testville.sandbox.my.site.com/ESWMessagingForInAppR1759343674368/assets/js/bootstrap.min.js' onload='initEmbeddedMessaging()'></script>

<!--<script type="text/javascript">-->
<!--  let chatWidgetInitialized = false;-->

<!--  document.addEventListener("astro:before-preparation", () => {-->
<!--    console.log("Cleaning up before page load...");-->
<!--    // This gets called before the page loads or navigates-->
<!--    // Remove any existing embedded messaging scripts to avoid duplicates-->
<!--    const existingScripts = document.querySelectorAll("script[src*=\"bootstrap.min.js\"]");-->
<!--    existingScripts.forEach(script => {-->
<!--      console.log("removing script", script);-->
<!--      script.remove();-->
<!--    });-->

<!--    // Look for and remove any iframes or containers the widget might have created-->
<!--    const widgetContainers = document.querySelectorAll("[class*=\"embeddedMessagingFrame\"]");-->
<!--    widgetContainers.forEach(container => {-->
<!--      console.log("removing container", container);-->
<!--      container.remove();-->
<!--    });-->

<!--    // Clean up global objects-->
<!--    if (window.embeddedservice_bootstrap) {-->
<!--      // // Try to call any cleanup/destroy methods if they exist-->
<!--      // if (typeof window.embeddedservice_bootstrap.destroy === 'function') {-->
<!--      //   window.embeddedservice_bootstrap.destroy();-->
<!--      // } else if (typeof window.embeddedservice_bootstrap.close === 'function') {-->
<!--      //   window.embeddedservice_bootstrap.close();-->
<!--      // }-->
<!--      delete window.embeddedservice_bootstrap;-->
<!--    }-->

<!--    chatWidgetInitialized = false;-->
<!--  });-->

<!--  document.addEventListener("astro:page-load", () => {-->
<!--    if (chatWidgetInitialized) {-->
<!--      return;-->
<!--    }-->

<!--    // This gets called whenever the page loads or navigates-->
<!--    function initEmbeddedMessaging() {-->
<!--      try {-->
<!--        if (!window.embeddedservice_bootstrap) {-->
<!--          console.warn('embeddedservice_bootstrap not available');-->
<!--          return;-->
<!--        }-->

<!--        embeddedservice_bootstrap.settings.language = "en_US";-->

<!--        embeddedservice_bootstrap.init(-->
<!--          "00DWC000002CRRV",-->
<!--          "Messaging_For_In_App_Rad_1",-->
<!--          "https://wheretherebedragons&#45;&#45;testville.sandbox.my.site.com/ESWMessagingForInAppR1759343674368",-->
<!--          {-->
<!--            scrt2URL: "https://wheretherebedragons&#45;&#45;testville.sandbox.my.salesforce-scrt.com"-->
<!--          }-->
<!--        );-->
<!--        chatWidgetInitialized = true;-->
<!--        console.log('Chat widget initialized successfully');-->
<!--      } catch (err) {-->
<!--        console.error("Error loading Embedded Messaging: ", err);-->
<!--        chatWidgetInitialized = false;-->
<!--      }-->
<!--    }-->

<!--    // Check if script is already loaded to avoid duplicates-->
<!--    if (window.embeddedservice_bootstrap) {-->
<!--      initEmbeddedMessaging();-->
<!--      return;-->
<!--    }-->

<!--    // Dynamically load the bootstrap script-->
<!--    const script = document.createElement("script");-->
<!--    script.type = "text/javascript";-->
<!--    script.src = "https://wheretherebedragons&#45;&#45;testville.sandbox.my.site.com/ESWMessagingForInAppR1759343674368/assets/js/bootstrap.min.js";-->
<!--    script.onload = initEmbeddedMessaging;-->
<!--    script.onerror = () => {-->
<!--      console.error('Failed to load chat widget script');-->
<!--      chatWidgetInitialized = false;-->
<!--    };-->
<!--    document.head.appendChild(script);-->
<!--  });-->
<!--</script>-->

<script>
  import { navigate } from 'astro:transitions/client';

  // Check if we're on a page that needs the chat widget
  if (typeof window !== 'undefined') {
    // List of paths where chat should work
    const chatPaths = ['/blog', '/contact', '/help'];
    const currentPath = window.location.pathname;

    document.addEventListener('astro:before-preparation', (event) => {
      console.log('navigating away from', currentPath);
      console.log('navigating to', event.to.pathname);

      const targetUrl = new URL(event.to);
      const isNavigatingToChatPage = chatPaths.some(path =>
        targetUrl.pathname.startsWith(path)
      );

      // If moving between chat and non-chat pages, do full reload
      if (isNavigatingToChatPage) {
        event.preventDefault();
        window.location.href = event.to.href;
      }
    });
  }
</script>

</html>
