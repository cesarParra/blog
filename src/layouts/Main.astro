---
import Header from "../components/Header.astro";
import BaseHead from "../components/BaseHead.astro";
import { Footer } from "../components/Footer.tsx";
import { Container } from "../components/Container.tsx";

const { title, description, isHomePage = false } = Astro.props;
---
<!doctype html>
<html class="h-full antialiased" lang="en">
<head>
  <BaseHead title={ title } description={ description }/>

  <style is:global>
      .closeButton {
          display: none;
      }
  </style>

  <style>
      .closeButton {
          display: none;
      }
  </style>
</head>

<body class="flex min-h-full bg-slate-50 dark:bg-black">
<main class="flex w-full">
  <div class="fixed inset-0 flex justify-center sm:px-8">
    <div class="flex w-full max-w-7xl lg:px-8">
      <div class="w-full bg-white ring-1 ring-slate-100 dark:bg-slate-900 dark:ring-slate-300/20"/>
    </div>
  </div>
  <div class="relative flex w-full flex-col">
    <Header isHomePage={ isHomePage }/>
    <main class="flex-auto">
      <slot/>
    </main>
    <Container>
      <Footer/>
    </Container>
  </div>
</main>
</body>

<script type="text/javascript" is:inline>
  document.addEventListener("astro:before-preparation", (event) => {
    //event.preventDefault();
    console.log(event);
    console.log("Cleaning up before page load...");
    if (window.embeddedservice_bootstrap) {
      embeddedservice_bootstrap.userVerificationAPI.clearSession(true).then(() => {
        embeddedservice_bootstrap.utilAPI.removeAllComponents();
      });
    }
  });

  document.addEventListener("astro:page-load", () => {
    // This gets called whenever the page loads or navigates
    function initEmbeddedMessaging() {
      try {
        embeddedservice_bootstrap.settings.language = "en_US";

        embeddedservice_bootstrap.init(
          "00DWC000002CRRV",
          "Messaging_For_In_App_Rad_1",
          "https://wheretherebedragons--testville.sandbox.my.site.com/ESWMessagingForInAppR1759343674368",
          {
            scrt2URL: "https://wheretherebedragons--testville.sandbox.my.salesforce-scrt.com"
          }
        );
      } catch (err) {
        console.error("Error loading Embedded Messaging: ", err);
      }
    }

    // Check if script is already loaded to avoid duplicates
    if (window.embeddedservice_bootstrap) {
      initEmbeddedMessaging();
      return;
    }

    // Dynamically load the bootstrap script
    const script = document.createElement("script");
    script.type = "text/javascript";
    script.src = "https://wheretherebedragons--testville.sandbox.my.site.com/ESWMessagingForInAppR1759343674368/assets/js/bootstrap.min.js";
    script.onload = initEmbeddedMessaging;
    document.head.appendChild(script);
  });
</script>

</html>
